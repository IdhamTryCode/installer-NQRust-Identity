volumes:
  data:
  qdrant_data:
  northwind_data:


networks:
  analytics:
    driver: bridge

services:
  bootstrap:
    build:
      context: ./bootstrap
      dockerfile: Dockerfile
    restart: on-failure
    platform: linux/amd64
    environment:
      DATA_PATH: /app/data
    volumes:
      - data:/app/data
    command: /bin/sh /app/init.sh

  analytics-engine:
    image: ghcr.io/nexusquantum/analytics-engine:latest
    restart: on-failure
    platform: ${PLATFORM}
    env_file:
      - .env
    ports:
      - "${ANALYTICS_ENGINE_PORT}:${ANALYTICS_ENGINE_PORT}"
    volumes:
      - data:/usr/src/app/etc
      - ${PROJECT_DIR}/data:/usr/src/app/data
    networks:
      - analytics
    depends_on:
      - bootstrap

  ibis-server:
    image: ghcr.io/nexusquantum/analytics-engine-ibis:latest
    restart: on-failure
    platform: ${PLATFORM}
    env_file:
      - .env
    ports:
      - "${IBIS_SERVER_PORT}:${IBIS_SERVER_PORT}"
    volumes:
      - ${LOCAL_STORAGE:-.}:/usr/src/app/data
    networks:
      - analytics
    depends_on:
      - analytics-engine

  analytics-service:
    image: ghcr.io/nexusquantum/analytics-service:latest
    restart: on-failure
    platform: linux/amd64
    env_file:
      - .env
    ports:
      - "5555:5555"
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ./data:/app/data:ro
    networks:
      - analytics
    depends_on:
      - qdrant

  qdrant:
    image: qdrant/qdrant:v1.11.0
    restart: on-failure
    expose:
      - 6333
      - 6334
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - analytics

  # Northwind PostgreSQL Demo Database + Analytics Application Database
  northwind-db:
    image: postgres:15
    restart: unless-stopped
    env_file:
      - .env
    environment:
      PGPORT: ${POSTGRES_PORT}
    command: [ "postgres", "-p", "${POSTGRES_PORT}" ]
    ports:
      - "${POSTGRES_PORT}:${POSTGRES_PORT}"
    healthcheck:
      test: [ "CMD-SHELL", "psql -p ${POSTGRES_PORT} -U ${POSTGRES_USER:-demo} -d ${POSTGRES_DB:-northwind} -c \"SELECT 1 FROM pg_constraint WHERE conname = 'fk_orders_customers'\"" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - analytics
    volumes:
      - ./00-init-analytics-db.sql:/docker-entrypoint-initdb.d/00-init-analytics-db.sql:ro
      - ./northwind.sql:/docker-entrypoint-initdb.d/northwind.sql:ro
      - ./scripts/ensure-analytics-db.sh:/docker-entrypoint-initdb.d/99-ensure-analytics-db.sh:ro
      - northwind_data:/var/lib/postgresql/data

  # Ensures analytics user and DB exist (idempotent). Needed when volume already existed before 00-init-analytics-db.sql was added.
  analytics-db-init:
    image: postgres:15
    env_file:
      - .env
    environment:
      PGHOST: northwind-db
      PGPORT: ${POSTGRES_PORT}
      PGUSER: ${POSTGRES_USER:-demo}
      PGPASSWORD: ${POSTGRES_PASSWORD:-demo123}
    volumes:
      - ./scripts/ensure-analytics-db.sh:/ensure-analytics-db.sh:ro
    entrypoint: [ "/bin/sh", "/ensure-analytics-db.sh" ]
    networks:
      - analytics
    depends_on:
      northwind-db:
        condition: service_healthy
    restart: "no"

  analytics-ui:
    image: ghcr.io/nexusquantum/analytics-ui:latest
    restart: on-failure
    platform: linux/amd64
    env_file:
      - .env
    ports:
      - "3000:3000"
    volumes:
      - data:/app/data
    networks:
      - analytics
    depends_on:
      - analytics-db-init
      - analytics-service
      - analytics-engine
      - ibis-server
