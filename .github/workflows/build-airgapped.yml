name: Build Airgapped Binary

on:
    # Trigger on release
    release:
        types: [published]

    # Trigger on push to main
    push:
        branches:
            - main
        paths:
            - "src/**"
            - "scripts/airgapped/**"
            - "Cargo.toml"
            - "Cargo.lock"
            - "docker-compose.yaml"
            - ".github/workflows/build-airgapped.yml"

    # Trigger on PR to main
    pull_request:
        branches:
            - main

    # Manual trigger
    workflow_dispatch:
        inputs:
            tag:
                description: "Release tag (e.g., v1.0.0)"
                required: false
                default: "latest"
            upload_to_release:
                description: "Upload to latest release (true/false)"
                required: false
                default: "false"

env:
    CARGO_TERM_COLOR: always
    BIN_NAME: nqrust-identity-airgapped

permissions:
    contents: write
    packages: read

jobs:
    build-airgapped:
        name: Build Airgapped Binary
        runs-on: ubuntu-latest
        timeout-minutes: 60

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gzip tar coreutils jq

            - name: Login to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Verify Docker authentication
              run: |
                  echo "Testing GHCR authentication for nqrust-identity..."
                  IMAGE="ghcr.io/nexusquantum/nqrust-identity:latest"
                  if docker manifest inspect "${IMAGE}" > /dev/null 2>&1; then
                    echo "âœ… Authentication successful â€” image ${IMAGE} is accessible"
                  else
                    echo "âŒ Cannot access ${IMAGE}"
                    echo "âš ï¸  Please ensure GHCR_TOKEN secret has 'read:packages' scope"
                    exit 1
                  fi

            - name: Build airgapped binary
              run: |
                  chmod +x scripts/airgapped/build-single-binary.sh
                  chmod +x scripts/airgapped/save-images.sh
                  chmod +x scripts/airgapped/build-payload.sh
                  ./scripts/airgapped/build-single-binary.sh --force-refresh

            - name: Validate binary
              run: |
                  echo "Validating airgapped binary..."

                  if [ ! -f "${BIN_NAME}" ]; then
                    echo "âŒ Binary not found!"
                    exit 1
                  fi

                  # Check file size (should be > 1 GB with payload)
                  SIZE=$(stat -c%s "${BIN_NAME}")
                  echo "Binary size: $(numfmt --to=iec-i --suffix=B $SIZE)"
                  if [ $SIZE -lt 1000000000 ]; then
                    echo "âŒ Binary too small ($SIZE bytes), likely missing payload"
                    exit 1
                  fi

                  # Check payload marker exists
                  if ! grep -qF "__NQRUST_PAYLOAD__" "${BIN_NAME}"; then
                    echo "âŒ Payload marker not found in binary"
                    exit 1
                  fi

                  # Verify checksum
                  if sha256sum -c "${BIN_NAME}.sha256"; then
                    echo "âœ… Checksum verification passed"
                  else
                    echo "âŒ Checksum verification failed"
                    exit 1
                  fi

                  echo "âœ… Binary validation passed"

            - name: Generate build info
              run: |
                  IDENTITY_TAG=$(cat build/images/manifest.json | jq -r '.identity_tag // "latest"')
                  cat > build-info.txt <<EOF
                  Build Information â€” NQRust Identity Airgapped Installer
                  ==========================================================

                  Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  Git Commit: ${{ github.sha }}
                  Git Ref: ${{ github.ref }}
                  Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

                  Binary Details
                  ==============
                  File: ${BIN_NAME}
                  Size: $(stat -c%s ${BIN_NAME} | numfmt --to=iec-i --suffix=B)
                  SHA256: $(cat ${BIN_NAME}.sha256)

                  Included Docker Images
                  ======================
                  $(cat build/images/manifest.json | jq -r '.images[] | "- \(.name)"')

                  Identity Tag Used: ${IDENTITY_TAG}

                  Installation
                  ============
                  1. Download ${BIN_NAME}
                  2. Verify: sha256sum -c ${BIN_NAME}.sha256
                  3. Make executable: chmod +x ${BIN_NAME}
                  4. Run: ./${BIN_NAME}
                  EOF

            - name: Upload to release
              if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true')
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      ${{ env.BIN_NAME }}
                      ${{ env.BIN_NAME }}.sha256
                      build-info.txt
                      build/images/manifest.json
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: airgapped-binary-${{ github.ref_name }}-${{ github.sha }}
                  path: |
                      ${{ env.BIN_NAME }}
                      ${{ env.BIN_NAME }}.sha256
                      build-info.txt
                      build/images/manifest.json
                      build/images/SHA256SUMS
                  retention-days: 30

            - name: Summary
              run: |
                  IDENTITY_TAG=$(cat build/images/manifest.json | jq -r '.identity_tag // "latest"')
                  echo "## ðŸŽ‰ NQRust Identity Airgapped Binary Build Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Build Information" >> $GITHUB_STEP_SUMMARY
                  echo "- **Binary Size**: $(stat -c%s ${BIN_NAME} | numfmt --to=iec-i --suffix=B)" >> $GITHUB_STEP_SUMMARY
                  echo "- **SHA256**: \`$(cat ${BIN_NAME}.sha256 | cut -d' ' -f1)\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Identity Tag**: \`${IDENTITY_TAG}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Git Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Included Images" >> $GITHUB_STEP_SUMMARY
                  cat build/images/manifest.json | jq -r '.images[] | "- **\(.name)**"' >> $GITHUB_STEP_SUMMARY
