name: Build Docker Airgapped Bundle

on:
    # Trigger on release
    release:
        types: [published]

    # Trigger on push to specific branches
    push:
        branches:
            - main
            - airgapped-single-binary-2
        paths:
            - "scripts/airgapped/download-docker-packages.sh"
            - "scripts/airgapped/build-docker-airgapped-bundle.sh"
            - "scripts/airgapped/install-docker-offline.sh"
            - ".github/workflows/build-docker-bundle.yml"

    # Manual trigger
    workflow_dispatch:
        inputs:
            distros:
                description: "Distros to build (space-separated: ubuntu24.04 ubuntu22.04 debian12)"
                required: false
                default: "ubuntu24.04 ubuntu22.04"
            upload_to_release:
                description: "Upload to latest release (true/false)"
                required: false
                default: "false"

env:
    DEBIAN_FRONTEND: noninteractive

permissions:
    contents: write

jobs:
    build-docker-bundle:
        name: Build Docker Airgapped Bundle
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker bundles
              run: |
                  DISTROS="${{ github.event.inputs.distros || 'ubuntu24.04 ubuntu22.04' }}"
                  echo "Building Docker bundles for: $DISTROS"

                  chmod +x scripts/airgapped/build-docker-airgapped-bundle.sh
                  chmod +x scripts/airgapped/download-docker-packages.sh
                  chmod +x scripts/airgapped/install-docker-offline.sh

                  # Build for each distro
                  for distro in $DISTROS; do
                    echo "Building for $distro..."
                    ./scripts/airgapped/build-docker-airgapped-bundle.sh "$distro"
                  done

            - name: List generated bundles
              run: |
                  echo "Generated bundles:"
                  ls -lh build/docker-airgapped-*.tar.gz || echo "No bundles found"

                  if [ -d build/docker-packages ]; then
                    echo ""
                    echo "Package directories:"
                    ls -lh build/docker-packages/
                  fi

            - name: Generate bundle info
              run: |
                  cat > build/docker-bundle-info.txt <<EOF
                  Docker Airgapped Bundle Information
                  ====================================

                  Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  Git Commit: ${{ github.sha }}
                  Git Ref: ${{ github.ref }}
                  Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

                  Included Distros
                  ================
                  $(ls build/docker-packages/ 2>/dev/null | sed 's/^/- /' || echo "None")

                  Bundle Files
                  ============
                  $(ls -lh build/docker-airgapped-*.tar.gz 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' || echo "None")

                  Installation Instructions
                  =========================
                  1. Transfer docker-airgapped-*.tar.gz to airgapped machine
                  2. Extract: tar xzf docker-airgapped-*.tar.gz
                  3. Navigate: cd docker-packages/<distro>  # e.g., ubuntu24.04
                  4. Install: sudo ./install-docker-offline.sh
                  5. Add user to docker group: sudo usermod -aG docker \$USER
                  6. Logout and login again
                  7. Verify: docker --version && docker compose version

                  What's Included
                  ===============
                  - Docker CE (latest stable)
                  - Docker Compose v2 (plugin)
                  - Docker Buildx (plugin)
                  - containerd.io
                  - All required dependencies (.deb packages)

                  For detailed instructions, see:
                  https://github.com/${{ github.repository }}/blob/main/docs/AIRGAPPED-INSTALLATION.md
                  EOF

            - name: Upload to release
              if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true')
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      build/docker-airgapped-*.tar.gz
                      build/docker-bundle-info.txt
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: docker-bundle-${{ github.ref_name }}-${{ github.sha }}
                  path: |
                      build/docker-airgapped-*.tar.gz
                      build/docker-bundle-info.txt
                      build/docker-packages/*/install-docker-offline.sh
                  retention-days: 30

            - name: Summary
              run: |
                  echo "## ðŸ³ Docker Airgapped Bundle Build Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Build Information" >> $GITHUB_STEP_SUMMARY
                  echo "- **Git Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Generated Bundles" >> $GITHUB_STEP_SUMMARY
                  for bundle in build/docker-airgapped-*.tar.gz; do
                    if [ -f "$bundle" ]; then
                      SIZE=$(du -h "$bundle" | cut -f1)
                      NAME=$(basename "$bundle")
                      echo "- **$NAME**: $SIZE" >> $GITHUB_STEP_SUMMARY
                    fi
                  done
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Included Distros" >> $GITHUB_STEP_SUMMARY
                  if [ -d build/docker-packages ]; then
                    ls build/docker-packages/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Download" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ github.event_name }}" == "release" ]; then
                    echo "Bundles uploaded to release: ${{ github.event.release.html_url }}" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "Bundles available as workflow artifacts" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Installation" >> $GITHUB_STEP_SUMMARY
                  echo '```bash' >> $GITHUB_STEP_SUMMARY
                  echo 'tar xzf docker-airgapped-*.tar.gz' >> $GITHUB_STEP_SUMMARY
                  echo 'cd docker-packages/ubuntu24.04  # or your distro' >> $GITHUB_STEP_SUMMARY
                  echo 'sudo ./install-docker-offline.sh' >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
