name: Build Docker Airgapped Bundle

on:
    # Trigger only on release
    release:
        types: [published]

    # Manual trigger
    workflow_dispatch:
        inputs:
            upload_to_release:
                description: "Upload to latest release (true/false)"
                required: false
                default: "false"

env:
    DEBIAN_FRONTEND: noninteractive

permissions:
    contents: write

jobs:
    build-docker-bundle:
        name: Build Docker Bundle (${{ matrix.distro }})
        runs-on: ${{ matrix.runner }}
        timeout-minutes: 30

        strategy:
            fail-fast: false
            matrix:
                include:
                    # Each Ubuntu version must run on a matching runner so apt-get download works
                    - distro: ubuntu24.04
                      runner: ubuntu-24.04
                    - distro: ubuntu22.04
                      runner: ubuntu-22.04

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download Docker packages
              run: |
                  sudo chmod +x scripts/airgapped/download-docker-packages.sh
                  sudo chmod +x scripts/airgapped/install-docker-offline.sh
                  OUTDIR="$GITHUB_WORKSPACE/build/docker-packages/${{ matrix.distro }}"
                  sudo mkdir -p "$OUTDIR"
                  sudo ./scripts/airgapped/download-docker-packages.sh "${{ matrix.distro }}" "$OUTDIR"
                  # Copy install script into the bundle
                  sudo cp "$GITHUB_WORKSPACE/scripts/airgapped/install-docker-offline.sh" "$OUTDIR/"
                  sudo chmod +x "$OUTDIR/install-docker-offline.sh"
                  # Fix ownership so subsequent steps (without sudo) can access files
                  sudo chown -R "$USER:$USER" "$GITHUB_WORKSPACE/build"
                  ls -lh "$OUTDIR"

            - name: Create bundle tarball
              run: |
                  cd build
                  tar -czf "docker-airgapped-${{ matrix.distro }}.tar.gz" "docker-packages/${{ matrix.distro }}/"
                  echo "Bundle created:"
                  ls -lh "docker-airgapped-${{ matrix.distro }}.tar.gz"

            - name: Generate bundle info
              run: |
                  cat > build/docker-bundle-info-${{ matrix.distro }}.txt <<EOF
                  Docker Airgapped Bundle â€” NQRust Identity
                  ==========================================

                  Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  Distro: ${{ matrix.distro }}
                  Git Commit: ${{ github.sha }}

                  Installation Instructions
                  =========================
                  1. Transfer docker-airgapped-${{ matrix.distro }}.tar.gz to airgapped machine
                  2. Extract: tar xzf docker-airgapped-${{ matrix.distro }}.tar.gz
                  3. Navigate: cd docker-packages/${{ matrix.distro }}/
                  4. Install: sudo ./install-docker-offline.sh
                  5. Add user to docker group: sudo usermod -aG docker \$USER
                  6. Log out and log back in
                  7. Verify: docker --version && docker compose version
                  8. Now run the nqrust-identity-airgapped installer
                  EOF

            - name: Upload to release
              if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true')
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      build/docker-airgapped-${{ matrix.distro }}.tar.gz
                      build/docker-bundle-info-${{ matrix.distro }}.txt
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: docker-bundle-${{ matrix.distro }}-${{ github.sha }}
                  path: |
                      build/docker-airgapped-${{ matrix.distro }}.tar.gz
                      build/docker-bundle-info-${{ matrix.distro }}.txt
                  retention-days: 30

            - name: Summary
              run: |
                  SIZE=$(du -h "build/docker-airgapped-${{ matrix.distro }}.tar.gz" | cut -f1)
                  echo "## ðŸ³ Docker Bundle: ${{ matrix.distro }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Size**: $SIZE" >> $GITHUB_STEP_SUMMARY
                  echo "- **Distro**: ${{ matrix.distro }}" >> $GITHUB_STEP_SUMMARY
