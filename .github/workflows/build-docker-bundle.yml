name: Build Docker Airgapped Bundle

on:
    # Trigger on release
    release:
        types: [published]

    # Trigger on push to main (only when docker bundle scripts change)
    push:
        branches:
            - main
        paths:
            - "scripts/airgapped/download-docker-packages.sh"
            - "scripts/airgapped/build-docker-airgapped-bundle.sh"
            - "scripts/airgapped/install-docker-offline.sh"
            - ".github/workflows/build-docker-bundle.yml"

    # Manual trigger
    workflow_dispatch:
        inputs:
            distros:
                description: "Distros to build (space-separated: ubuntu24.04 ubuntu22.04 debian12)"
                required: false
                default: "ubuntu24.04 ubuntu22.04"
            upload_to_release:
                description: "Upload to latest release (true/false)"
                required: false
                default: "false"

env:
    DEBIAN_FRONTEND: noninteractive

permissions:
    contents: write

jobs:
    build-docker-bundle:
        name: Build Docker Airgapped Bundle
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker bundles
              run: |
                  DISTROS="${{ github.event.inputs.distros || 'ubuntu24.04 ubuntu22.04' }}"
                  echo "Building Docker bundles for: $DISTROS"

                  chmod +x scripts/airgapped/build-docker-airgapped-bundle.sh
                  chmod +x scripts/airgapped/download-docker-packages.sh
                  chmod +x scripts/airgapped/install-docker-offline.sh

                  mkdir -p build
                  for distro in $DISTROS; do
                    echo "Building for $distro..."
                    ./scripts/airgapped/build-docker-airgapped-bundle.sh "$distro"
                  done

            - name: List generated bundles
              run: |
                  echo "Generated bundles:"
                  ls -lh build/docker-airgapped-*.tar.gz || echo "No bundles found"

                  if [ -d build/docker-packages ]; then
                    echo ""
                    echo "Package directories:"
                    ls -lh build/docker-packages/
                  fi

            - name: Generate bundle info
              run: |
                  mkdir -p build
                  cat > build/docker-bundle-info.txt <<EOF
                  Docker Airgapped Bundle â€” NQRust Identity
                  ==========================================

                  Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  Git Commit: ${{ github.sha }}
                  Git Ref: ${{ github.ref }}

                  Purpose
                  =======
                  Use these bundles to install Docker on airgapped machines
                  before running the nqrust-identity-airgapped installer.

                  Included Distros
                  ================
                  $(ls build/docker-packages/ 2>/dev/null | sed 's/^/- /' || echo "None")

                  Bundle Files
                  ============
                  $(ls -lh build/docker-airgapped-*.tar.gz 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' || echo "None")

                  Installation Instructions
                  =========================
                  1. Transfer docker-airgapped-<distro>.tar.gz to airgapped machine
                  2. Extract: tar xzf docker-airgapped-<distro>.tar.gz
                  3. Navigate: cd <distro>/
                  4. Install: sudo ./install-docker-offline.sh
                  5. Add user to docker group: sudo usermod -aG docker \$USER
                  6. Log out and log back in
                  7. Verify: docker --version && docker compose version
                  8. Now run the nqrust-identity-airgapped installer
                  EOF

            - name: Upload to release
              if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true')
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      build/docker-airgapped-*.tar.gz
                      build/docker-bundle-info.txt
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: docker-bundle-${{ github.ref_name }}-${{ github.sha }}
                  path: |
                      build/docker-airgapped-*.tar.gz
                      build/docker-bundle-info.txt
                      build/docker-packages/*/install-docker-offline.sh
                  retention-days: 30

            - name: Summary
              run: |
                  echo "## ðŸ³ Docker Airgapped Bundle Build Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Generated Bundles" >> $GITHUB_STEP_SUMMARY
                  for bundle in build/docker-airgapped-*.tar.gz; do
                    if [ -f "$bundle" ]; then
                      SIZE=$(du -h "$bundle" | cut -f1)
                      NAME=$(basename "$bundle")
                      echo "- **$NAME**: $SIZE" >> $GITHUB_STEP_SUMMARY
                    fi
                  done
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Installation" >> $GITHUB_STEP_SUMMARY
                  echo '```bash' >> $GITHUB_STEP_SUMMARY
                  echo 'tar xzf docker-airgapped-ubuntu24.04.tar.gz' >> $GITHUB_STEP_SUMMARY
                  echo 'cd ubuntu24.04' >> $GITHUB_STEP_SUMMARY
                  echo 'sudo ./install-docker-offline.sh' >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
