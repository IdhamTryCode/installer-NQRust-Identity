name: CI

on:
  # pull_request:
  # push:
  #   branches:
  #     - main
  #     - master
  #     - develop
  release:
    types:
      - published

env:
  CARGO_TERM_COLOR: always

# ensure that the workflow is only triggered once per PR, subsequent pushes to the PR will cancel
# and restart the workflow. See https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  fmt:
    name: fmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: check formatting
        run: cargo fmt -- --check
      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
  clippy:
    name: clippy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Run clippy action
        uses: clechasseur/rs-clippy-check@v3
      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
  doc:
    # run docs generation on nightly rather than stable. This enables features like
    # https://doc.rust-lang.org/beta/unstable-book/language-features/doc-cfg.html which allows an
    # API be documented as only available in some specific platforms.
    name: doc
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Run cargo doc
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: --cfg docsrs
  test:
    runs-on: ${{ matrix.os }}
    name: test ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
    steps:
      # if your project needs OpenSSL, uncomment this to fix Windows builds.
      # it's commented out by default as the install command takes 5-10m.
      # - run: echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append
      #   if: runner.os == 'Windows'
      # - run: vcpkg install openssl:x64-windows-static-md
      #   if: runner.os == 'Windows'
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      # enable this ci template to run regardless of whether the lockfile is checked in or not
      - name: cargo generate-lockfile
        if: hashFiles('Cargo.lock') == ''
        run: cargo generate-lockfile
      - name: cargo test --locked
        run: cargo test --locked --all-features --all-targets
      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2

  build-airgapped:
    name: Build Airgapped Binary
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    timeout-minutes: 60
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gzip tar coreutils jq

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build airgapped binary
        run: |
          chmod +x scripts/airgapped/build-single-binary.sh
          chmod +x scripts/airgapped/save-images.sh
          chmod +x scripts/airgapped/build-payload.sh
          ./scripts/airgapped/build-single-binary.sh --force-refresh

      - name: Validate binary
        run: |
          echo "Validating airgapped binary..."

          # Check file exists
          if [ ! -f nqrust-analytics-airgapped ]; then
            echo "❌ Binary not found!"
            exit 1
          fi

          # Check file size (should be > 1 GB with payload)
          SIZE=$(stat -c%s nqrust-analytics-airgapped)
          echo "Binary size: $(numfmt --to=iec-i --suffix=B $SIZE)"
          if [ $SIZE -lt 1000000000 ]; then
            echo "❌ Binary too small ($SIZE bytes), likely missing payload"
            exit 1
          fi

          # Check payload marker exists
          if ! grep -q "__NQRUST_PAYLOAD__" nqrust-analytics-airgapped; then
            echo "❌ Payload marker not found in binary"
            exit 1
          fi

          # Verify checksum file
          if [ ! -f nqrust-analytics-airgapped.sha256 ]; then
            echo "❌ Checksum file not found"
            exit 1
          fi

          # Verify checksum
          if sha256sum -c nqrust-analytics-airgapped.sha256; then
            echo "✅ Checksum verification passed"
          else
            echo "❌ Checksum verification failed"
            exit 1
          fi

          echo "✅ Binary validation passed"

      - name: Generate build info
        run: |
          cat > build-info.txt <<EOF
          Build Information
          =================

          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${{ github.sha }}
          Git Ref: ${{ github.ref }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Binary Details
          ==============
          File: nqrust-analytics-airgapped
          Size: $(stat -c%s nqrust-analytics-airgapped | numfmt --to=iec-i --suffix=B)
          SHA256: $(cat nqrust-analytics-airgapped.sha256)

          Included Docker Images
          ======================
          $(cat build/images/manifest.json | jq -r '.images[] | "- \(.name) (\(.size | tonumber / 1048576 | floor)MB)"')

          Installation
          ============
          1. Download nqrust-analytics-airgapped
          2. Verify: sha256sum -c nqrust-analytics-airgapped.sha256
          3. Make executable: chmod +x nqrust-analytics-airgapped
          4. Run: ./nqrust-analytics-airgapped install

          For detailed instructions, see:
          https://github.com/${{ github.repository }}/blob/main/docs/AIRGAPPED-INSTALLATION.md
          EOF

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            nqrust-analytics-airgapped
            nqrust-analytics-airgapped.sha256
            build-info.txt
            build/images/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker-bundle:
    name: Build Docker Airgapped Bundle
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    timeout-minutes: 30
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker bundles
        run: |
          DISTROS="ubuntu24.04 ubuntu22.04"
          echo "Building Docker bundles for: $DISTROS"

          chmod +x scripts/airgapped/build-docker-airgapped-bundle.sh
          chmod +x scripts/airgapped/download-docker-packages.sh
          chmod +x scripts/airgapped/install-docker-offline.sh

          # Build for each distro
          for distro in $DISTROS; do
            echo "Building for $distro..."
            ./scripts/airgapped/build-docker-airgapped-bundle.sh "$distro"
          done

      - name: List generated bundles
        run: |
          echo "Generated bundles:"
          ls -lh build/docker-airgapped-*.tar.gz || echo "No bundles found"

          if [ -d build/docker-packages ]; then
            echo ""
            echo "Package directories:"
            ls -lh build/docker-packages/
          fi

      - name: Generate bundle info
        run: |
          cat > build/docker-bundle-info.txt <<EOF
          Docker Airgapped Bundle Information
          ====================================

          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${{ github.sha }}
          Git Ref: ${{ github.ref }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Included Distros
          ================
          $(ls build/docker-packages/ 2>/dev/null | sed 's/^/- /' || echo "None")

          Bundle Files
          ============
          $(ls -lh build/docker-airgapped-*.tar.gz 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' || echo "None")

          Installation Instructions
          =========================
          1. Transfer docker-airgapped-*.tar.gz to airgapped machine
          2. Extract: tar xzf docker-airgapped-*.tar.gz
          3. Navigate: cd docker-packages/<distro>  # e.g., ubuntu24.04
          4. Install: sudo ./install-docker-offline.sh
          5. Add user to docker group: sudo usermod -aG docker \$USER
          6. Logout and login again
          7. Verify: docker --version && docker compose version

          What's Included
          ===============
          - Docker CE (latest stable)
          - Docker Compose v2 (plugin)
          - Docker Buildx (plugin)
          - containerd.io
          - All required dependencies (.deb packages)

          For detailed instructions, see:
          https://github.com/${{ github.repository }}/blob/main/docs/AIRGAPPED-INSTALLATION.md
          EOF

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/docker-airgapped-*.tar.gz
            build/docker-bundle-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
